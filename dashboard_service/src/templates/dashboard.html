<!DOCTYPE html>
<html>

<head>
    <title>Log Analytics Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-row {
            transition: all 0.2s;
        }

        .log-debug {
            color: #6c757d;
        }

        .log-info {
            color: #0d6efd;
        }

        .log-warn {
            color: #fd7e14;
            font-weight: bold;
        }

        .log-error {
            color: #dc3545;
            font-weight: bold;
        }

        .log-fatal {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5 mb-5">
        <h1 class="text-center mb-4">Distributed Log Platform</h1>

        {% if user %}
        <div class="card shadow">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="me-2">Welcome, <strong>{{ user }}</strong></span>
                    <span class="badge bg-light text-success text-uppercase">{{ role }}</span>
                </div>
                <div class="d-flex gap-2">
                    {% if role == 'admin' %}
                    <a href="http://localhost:3000" target="_blank" class="btn btn-outline-light btn-sm">Grafana
                        Dashboard</a>
                    {% endif %}
                    <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
                </div>
            </div>

            <div class="card-body">

                {% if role == 'viewer' %}
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                        <path
                            d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                    </svg>
                    <div>
                        <strong>Viewer Mode:</strong> Sensitive logs (ERROR/FATAL) and Token details are hidden.
                    </div>
                </div>
                {% endif %}

                {% if role != 'viewer' %}
                <h5>Token Inspector</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Raw Access Token (JWT)</label>
                        <textarea class="form-control" rows="5" readonly
                            style="font-family: monospace; font-size: 0.75rem; background-color: #f8f9fa;">{{ token }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Decoded Payload (Claims)</label>
                        <pre class="border rounded p-3"
                            style="background-color: #2d2d2d; color: #00ff00; font-size: 0.75rem; max-height: 130px; overflow-y: auto;">{{ decoded_token }}</pre>
                    </div>
                </div>
                <hr class="mt-4 mb-4">
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Live Logs</h3>
                    {% if role != 'viewer' %}
                    <div class="btn-group">
                        <a href="/export?format=csv&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}"
                            class="btn btn-outline-primary btn-sm">Export CSV</a>
                        <a href="/export?format=json&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}"
                            class="btn btn-outline-secondary btn-sm">Export JSON</a>
                    </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <small class="text-muted d-block mb-2">Quick Ranges:</small>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(5)">Last
                            5m</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(15)">Last
                            15m</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(30)">Last
                            30m</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(60)">Last
                            1h</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(180)">Last
                            3h</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(360)">Last
                            6h</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(720)">Last
                            12h</button>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="input-group mb-2">
                            <span class="input-group-text">Saved Searches</span>
                            <select class="form-select" id="savedSearchSelect" onchange="loadSavedSearch()">
                                <option value="" selected>-- Load a Saved Search --</option>
                                {% for search in saved_searches %}
                                <option value="{{ search.id }}" data-query="{{ search.query }}"
                                    data-name="{{ search.name }}">
                                    {{ search.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-success" type="button" onclick="saveCurrentSearch()">Save
                                Current</button>
                            <button class="btn btn-outline-primary" type="button"
                                onclick="updateSelectedSearch()">Update</button>
                            <button class="btn btn-outline-danger" type="button"
                                onclick="deleteSelectedSearch()">Delete</button>
                        </div>
                    </div>
                </div>

                <form method="get" action="/" class="mb-4" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="q" class="form-control" placeholder="Search message..."
                                value="{{ q or '' }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="service" class="form-control" placeholder="Service"
                                value="{{ service or '' }}">
                        </div>
                        <div class="col-md-2">
                            <select name="level" class="form-select">
                                <option value="">All Levels</option>
                                <option value="INFO" {% if level=='INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARN" {% if level=='WARN' %}selected{% endif %}>WARN</option>
                                <option value="ERROR" {% if level=='ERROR' %}selected{% endif %}>ERROR</option>
                                <option value="DEBUG" {% if level=='DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="FATAL" {% if level=='FATAL' %}selected{% endif %}>FATAL</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="datetime-local" name="start_time" class="form-control"
                                value="{{ start_time or '' }}" title="Start Time">
                        </div>
                        <div class="col-md-2">
                            <input type="datetime-local" name="end_time" class="form-control"
                                value="{{ end_time or '' }}" title="End Time">
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary w-100">Filter</button>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="logTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Service</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr class="log-row">
                                <td class="text-nowrap small log-timestamp">{{ log.timestamp }}</td>
                                <td>
                                    <span class="
                                        {% if log.level == 'INFO' %} log-info
                                        {% elif log.level == 'WARN' %} log-warn
                                        {% elif log.level == 'ERROR' %} log-error
                                        {% elif log.level == 'FATAL' %} log-fatal
                                        {% else %} log-debug {% endif %}
                                    ">{{ log.level }}</span>
                                </td>
                                <td class="fw-bold text-secondary">{{ log.service }}</td>
                                <td>{{ log.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if not logs %}
                    <div class="text-center p-4 text-muted">
                        No logs found matching your criteria.
                    </div>
                    {% endif %}

                    {% if total_pages > 1 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                                <a class="page-link"
                                    href="/?page={{ page - 1 }}&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}">Previous</a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Page {{ page }} of {{ total_pages }} ({{ total_hits }}
                                    logs)</span>
                            </li>
                            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                                <a class="page-link"
                                    href="/?page={{ page + 1 }}&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>

            </div>
        </div>
        {% else %}
        <div class="card shadow w-50 mx-auto">
            <div class="card-body">
                <h5 class="card-title text-center">Login</h5>
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                <div class="text-center">
                    <p class="mb-4">Please sign in.</p>
                    <a href="/login" class="btn btn-primary btn-lg w-100">
                        Login with Keycloak
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        function setTimeRange(minutes) {
            const now = new Date();
            const start = new Date(now.getTime() - minutes * 60000);

            const formatForInput = (date) => {
                const offset = date.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(date - offset)).toISOString().slice(0, 16);
                return localISOTime;
            };

            document.querySelector('input[name="start_time"]').value = formatForInput(start);
            document.querySelector('input[name="end_time"]').value = formatForInput(now);

            document.getElementById('filterForm').submit();
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.log-timestamp').forEach(function (el) {
                const date = new Date(el.textContent);
                if (!isNaN(date.getTime())) {
                    el.textContent = date.toLocaleString('sv-SE');
                }
            });
        });
        async function saveCurrentSearch() {
            const name = prompt("Enter a name for this search:");
            if (!name) return;

            const queryObj = {
                q: document.querySelector('input[name="q"]').value,
                service: document.querySelector('input[name="service"]').value,
                level: document.querySelector('select[name="level"]').value,
                start_time: document.querySelector('input[name="start_time"]').value,
                end_time: document.querySelector('input[name="end_time"]').value
            };

            try {
                const response = await fetch('/searches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, query: JSON.stringify(queryObj) })
                });

                if (response.ok) {
                    alert("Search saved!");
                    location.reload();
                } else {
                    const err = await response.json();
                    alert("Error saving search: " + err.detail);
                }
            } catch (e) {
                alert("Network error: " + e);
            }
        }

        async function updateSelectedSearch() {
            const select = document.getElementById('savedSearchSelect');
            const searchId = select.value;
            if (!searchId) {
                alert("Please select a valid saved search to update.");
                return;
            }

            const confirmUpdate = confirm("Update '" + select.options[select.selectedIndex].text + "' with current filter criteria?");
            if (!confirmUpdate) return;

            const queryObj = {
                q: document.querySelector('input[name="q"]').value,
                service: document.querySelector('input[name="service"]').value,
                level: document.querySelector('select[name="level"]').value,
                start_time: document.querySelector('input[name="start_time"]').value,
                end_time: document.querySelector('input[name="end_time"]').value
            };

            try {
                const response = await fetch('/searches/' + searchId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: JSON.stringify(queryObj) })
                });

                if (response.ok) {
                    alert("Search updated!");
                    location.reload();
                } else {
                    const err = await response.json();
                    alert("Error updating search: " + err.detail);
                }
            } catch (e) {
                alert("Network error: " + e);
            }
        }

        async function deleteSelectedSearch() {
            const select = document.getElementById('savedSearchSelect');
            const searchId = select.value;
            if (!searchId) {
                alert("Please select a valid saved search to delete.");
                return;
            }

            if (!confirm("Are you sure you want to delete this saved search?")) return;

            try {
                const response = await fetch('/searches/' + searchId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("Search deleted!");
                    location.reload();
                } else {
                    const err = await response.json();
                    alert("Error deleting search: " + err.detail);
                }
            } catch (e) {
                alert("Network error: " + e);
            }
        }

        function loadSavedSearch() {
            const select = document.getElementById('savedSearchSelect');
            const option = select.options[select.selectedIndex];
            if (!option.value) return;

            const queryData = JSON.parse(option.getAttribute('data-query'));
            if (!queryData) return;

            document.querySelector('input[name="q"]').value = queryData.q || "";
            document.querySelector('input[name="service"]').value = queryData.service || "";
            document.querySelector('select[name="level"]').value = queryData.level || "";
            document.querySelector('input[name="start_time"]').value = queryData.start_time || "";
            document.querySelector('input[name="end_time"]').value = queryData.end_time || "";

            // Optional: Auto submit to see results immediately
            document.getElementById('filterForm').submit();
        }
    </script>
</body>

</html>