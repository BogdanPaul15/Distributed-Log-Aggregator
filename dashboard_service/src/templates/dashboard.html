<!DOCTYPE html>
<html>
<head>
    <title>Log Analytics Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-row { transition: all 0.2s; }
        .log-debug { color: #6c757d; }
        .log-info { color: #0d6efd; }
        .log-warn { color: #fd7e14; font-weight: bold; }
        .log-error { color: #dc3545; font-weight: bold; }
        .log-fatal { background-color: #dc3545; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5 mb-5">
        <h1 class="text-center mb-4">Distributed Log Platform</h1>
        
        {% if user %}
        <div class="card shadow">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="me-2">Welcome, <strong>{{ user }}</strong></span>
                    <span class="badge bg-light text-success text-uppercase">{{ role }}</span>
                </div>
                <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
            
            <div class="card-body">
                
                {% if role == 'viewer' %}
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                    <div>
                        <strong>Viewer Mode:</strong> Sensitive logs (ERROR/FATAL) and Token details are hidden.
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">
                        <h5>System Status</h5>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Database Connection <span class="badge bg-primary rounded-pill">Active</span>
                            </li>
                            {% if role != 'viewer' %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Ingestion API <span class="badge bg-secondary rounded-pill">Running on Port 8001</span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                         <h5>SSO Context</h5>
                         <p class="text-muted small">Authenticated via Keycloak (OpenID Connect)</p>
                    </div>
                </div>

                <hr>
                
                {% if role != 'viewer' %}
                <h5>Token Inspector</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Raw Access Token (JWT)</label>
                        <textarea class="form-control" rows="5" readonly style="font-family: monospace; font-size: 0.75rem; background-color: #f8f9fa;">{{ token }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Decoded Payload (Claims)</label>
                        <pre class="border rounded p-3" style="background-color: #2d2d2d; color: #00ff00; font-size: 0.75rem; max-height: 130px; overflow-y: auto;">{{ decoded_token }}</pre>
                    </div>
                </div>
                <hr class="mt-4 mb-4">
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Live Logs</h3>
                    {% if role != 'viewer' %}
                    <div class="btn-group">
                        <a href="/export?format=csv&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}" class="btn btn-outline-primary btn-sm">Export CSV</a>
                        <a href="/export?format=json&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}" class="btn btn-outline-secondary btn-sm">Export JSON</a>
                    </div>
                    {% endif %}
                </div>
                
                <form method="get" action="/" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="q" class="form-control" placeholder="Search message..." value="{{ q or '' }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="service" class="form-control" placeholder="Service" value="{{ service or '' }}">
                        </div>
                        <div class="col-md-2">
                            <select name="level" class="form-select">
                                <option value="">All Levels</option>
                                <option value="INFO" {% if level == 'INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARN" {% if level == 'WARN' %}selected{% endif %}>WARN</option>
                                <option value="ERROR" {% if level == 'ERROR' %}selected{% endif %}>ERROR</option>
                                <option value="DEBUG" {% if level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="FATAL" {% if level == 'FATAL' %}selected{% endif %}>FATAL</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="datetime-local" name="start_time" class="form-control" value="{{ start_time or '' }}" title="Start Time">
                        </div>
                        <div class="col-md-2">
                            <input type="datetime-local" name="end_time" class="form-control" value="{{ end_time or '' }}" title="End Time">
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary w-100">Filter</button>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="logTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Service</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr class="log-row">
                                <td class="text-nowrap small">{{ log.timestamp }}</td>
                                <td>
                                    <span class="
                                        {% if log.level == 'INFO' %} log-info
                                        {% elif log.level == 'WARN' %} log-warn
                                        {% elif log.level == 'ERROR' %} log-error
                                        {% elif log.level == 'FATAL' %} log-fatal
                                        {% else %} log-debug {% endif %}
                                    ">{{ log.level }}</span>
                                </td>
                                <td class="fw-bold text-secondary">{{ log.service }}</td>
                                <td>{{ log.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if not logs %}
                    <div class="text-center p-4 text-muted">
                        No logs found matching your criteria.
                    </div>
                    {% endif %}

                    {% if total_pages > 1 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                                <a class="page-link" href="/?page={{ page - 1 }}&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}">Previous</a>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Page {{ page }} of {{ total_pages }} ({{ total_hits }} logs)</span>
                            </li>
                            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                                <a class="page-link" href="/?page={{ page + 1 }}&q={{ q or '' }}&service={{ service or '' }}&level={{ level or '' }}&start_time={{ start_time or '' }}&end_time={{ end_time or '' }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>

            </div>
        </div>
        {% else %}
        <div class="card shadow w-50 mx-auto">
            <div class="card-body">
                <h5 class="card-title text-center">Login</h5>
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                <form action="/login" method="post">
                    <div class="mb-3">
                        <label>Username</label>
                        <input type="text" name="username" class="form-control" placeholder="" required>
                    </div>
                    <div class="mb-3">
                        <label>Password</label>
                        <input type="password" name="password" class="form-control" placeholder="" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Sign In</button>
                    <div class="text-center mt-3">
                        <small class="text-muted">Try username: <code>testuser</code> or <code>viewer</code></small>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</body>
</html>